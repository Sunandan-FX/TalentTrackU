{% extends 'base.html' %}
{% block title %}Internships{% endblock %}
{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Internships</h1>
    {% if user.is_authenticated %}
        <a href="{% url 'internship_post_create' %}" class="btn btn-success mb-3">Post New Internship</a>
    {% endif %}
    <div class="row">
        {% if internships %}
            {% for internship in internships %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ internship.title }}</h5>
                        <p><strong>Company:</strong> {{ internship.company }}</p>
                        <p><strong>Description:</strong> {{ internship.description }}</p>
                        <p><strong>Duration:</strong> {{ internship.duration }}</p>
                        <p><strong>Location:</strong> {{ internship.location }}</p>
                        <p class="text-muted small">Posted: {{ internship.created_at|date:"M d, Y" }}</p>
                        {% if internship.pdf %}
                            <p><strong>PDF:</strong> <a href="{{ internship.pdf.url }}" download>Download PDF</a></p>
                        {% endif %}

                        {% if user.is_authenticated %}
                            {# Show applicant's application status #}
                            {% with my_applications=internship.applications.all|dictsortreversed:"applied_at" %}
                                {% for app in my_applications %}
                                    {% if app.applicant == user %}
                                        <span class="badge bg-success">Applied</span>
                                        <p><strong>Status:</strong> {{ app.get_status_display }}</p>
                                        {% if app.resume %}
                                            <p><strong>Your Resume:</strong> <a href="{{ app.resume.url }}" download>Download</a></p>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if not my_applications|length or not my_applications|dictsortreversed:"applied_at"|yesno:"1,0" %}
                                    <a href="{% url 'internship_apply' internship.id %}" class="btn btn-primary">Apply</a>
                                {% endif %}
                            {% endwith %}

                            {# Show manage links for post owner #}
                            {% if internship.posted_by == user %}
                                <a href="{% url 'internship_delete' internship.id %}" 
                                   class="btn btn-danger btn-sm" 
                                   onclick="return confirm('Are you sure?')">Delete</a>
                                <hr>
                                <h6>Applications:</h6>
                                {% for app in internship.applications.all %}
                                    <div class="border rounded p-2 mb-2">
                                        <strong>{{ app.applicant.username }}</strong> - {{ app.get_status_display }}
                                        <a href="{% url 'internship_application_manage' app.id %}" class="btn btn-outline-primary btn-sm ms-2">Manage</a>
                                    </div>
                                {% empty %}
                                    <p class="text-muted">No applications yet.</p>
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>No internships posted yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
